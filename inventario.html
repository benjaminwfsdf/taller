<!DOCTYPE html>
<html lang="es-CL">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üì¶ Inventario ¬∑ Aceites</title>

<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json">

<style>
/* ============================
   VARIABLES PRINCIPALES
============================ */
:root{
  --brand:#d40000;
  --brand-dark:#9b0000;

  --blue:#1d3053;
  --ink:#ffffff;

  --radius:18px;
  --shadow:0 12px 30px rgba(0,0,0,.45);
  --shadow-soft:0 10px 26px rgba(0,0,0,.25);
}

* {
  box-sizing: border-box;
}

/* ============================
   CUERPO
============================ */
body{
  margin:0;
  background-image: url("img/portada_celular.png");
  background-repeat: no-repeat;
  background-size: cover;
  background-position: center;
  background-attachment: scroll; /* evita el bug */
  min-height: 100vh;
  overflow-x: hidden;
}

/* ============================
   TOPBAR
============================ */
.topbar{
  background:#1d3053;
  color:white;
  text-align:center;
  padding:14px;
  font-weight:700;
  border-bottom:5px solid var(--brand);
  box-shadow:var(--shadow-soft);
  font-size:clamp(1rem, 4vw, 1.25rem);
  position: sticky;
  top: 0;
  z-index: 10;
}

/* ============================
   WRAPPER + FRAME
============================ */
.wrapper{
  max-width:1100px;
  margin:40px auto 60px;
  padding:0 22px;
  width: 100%;
}

.frame{
  background:rgba(135,206,250,0.35);
  border-radius:var(--radius);
  padding:25px;
  border:3px solid var(--brand);
  backdrop-filter:blur(8px);
  box-shadow:var(--shadow);
  margin: 0 auto;
}

/* ============================
   T√çTULO PRINCIPAL
============================ */
.header{
  background:#1d3053;
  border:3px solid var(--brand);
  border-radius:16px;
  text-align:center;
  padding:20px;
  margin-bottom:22px;
  font-size:clamp(1.4rem, 4vw, 1.9rem);
  font-weight:900;
  text-shadow:0 3px 8px rgba(0,0,0,.6);
  color: white;
}

/* ============================
   CARD SECCI√ìN
============================ */
.card{
  background:#1d3053;
  border:3px solid var(--brand);
  border-radius:16px;
  padding:18px;
  box-shadow:var(--shadow);
  margin-bottom:22px;
  width: 100%;
}

.card h2 {
  margin: 0 0 16px 0;
  font-size: clamp(1.2rem, 4vw, 1.6rem);
  font-weight: 900;
  color: white;
}

/* ============================
   BOT√ìN VOLVER
============================ */
.btn-back{
  display:inline-block;
  background:white;
  color:black;
  padding:12px 24px;
  border-radius:14px;
  border:3px solid var(--brand);
  font-weight:900;
  font-size: clamp(1rem, 3vw, 1.1rem);
  text-decoration:none;
  box-shadow:0 5px 12px rgba(0,0,0,.35);
  transition:.25s;
  text-align: center;
  margin-bottom: 16px;
  width: 100%;
}
.btn-back:hover{
  background:var(--blue);
  color:white;
  border-color:var(--brand-dark);
}

/* ============================
   INPUTS
============================ */
input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:2px solid var(--brand);
  background:rgba(0,0,0,0.3);
  color:white;
  font-size: clamp(1rem, 3vw, 1.1rem);
  margin-bottom: 12px;
  box-sizing: border-box;
}

input:focus {
  outline: none;
  border-color: var(--brand-dark);
}

/* ============================
   GRID INPUTS
============================ */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:12px;
}

/* ============================
   BOT√ìN GUARDAR / RECARGAR
============================ */
.btn{
  background:white;
  color:black;
  padding:14px 16px;
  border-radius:14px;
  border:3px solid var(--brand);
  font-weight:900;
  cursor:pointer;
  font-size: clamp(1rem, 3vw, 1.1rem);
  margin:14px auto 0;
  display:block;
  width:100%;
  max-width:280px;
  text-align:center;
  box-shadow:0 5px 12px rgba(0,0,0,.35);
  transition: .25s;
}
.btn:hover{
  background:var(--blue);
  color:white;
  border-color:var(--brand-dark);
}

/* ============================
   TABLA
============================ */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
  font-size:clamp(0.8rem, 2.5vw, 1rem);
}
th,td{
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.25);
  text-align:center;
}

th {
  background: var(--brand);
  color: white;
  font-weight: 700;
}

td {
  background: rgba(0,0,0,0.2);
}

.badge{
  padding:6px 12px;
  border-radius:20px;
  font-size: clamp(0.7rem, 2.5vw, 0.9rem);
  font-weight: 600;
}
.badge.ok{background:#163016;color:#a8f0a9;}
.badge.off{background:#301616;color:#f0a8a8;}

/* FOOTER */
.footer{
  text-align:center;
  color:white;
  font-size:13px;
  margin-top:22px;
  text-shadow:0 2px 6px black;
  padding: 0 10px;
}

/* Mejoras para m√≥viles */
@media (max-width: 768px) {
  .wrapper {
    margin: 20px auto 40px;
    padding: 0 12px;
  }
  
  .frame {
    padding: 16px;
  }
  
  .card {
    padding: 16px;
  }
  
  .grid {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  
  table {
    display: block;
    overflow-x: auto;
  }
  
  th, td {
    padding: 8px 6px;
    font-size: clamp(0.7rem, 2.5vw, 0.9rem);
  }
  
  input, .btn, .btn-back {
    padding: 16px;
  }
}

@media (max-width: 480px) {
  th, td {
    padding: 6px 4px;
  }
  
  .badge {
    padding: 4px 8px;
  }
}
/* === FIX GLOBAL PARA iPHONE Y CELULAR === */
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
}

body {
  position: relative;
  min-height: 100dvh; /* üëà corrige bug de Safari */
  overflow-x: hidden;
  background-color: #000; /* evita blancos */
}

/* El fondo real se genera aqu√≠ */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background-image: inherit;    /* usa tu fondo ya definido */
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  z-index: -1;
  pointer-events: none;
}
/* ============================
   üî• FORZAR TEXTO BLANCO GLOBAL
   ============================ */
body,
body * {
  color: white !important;
}

/* ============================
   üî• EXCEPCIONES NECESARIAS
   ============================ */

/* Botones con fondo blanco ‚Üí texto negro */
.btn,
.btn *,
.btn-back,
.btn-back * {
  color: black !important;
}

/* Inputs y su texto (para que se lean bien sobre fondo blanco/transparente) */
input,
input *,
input::placeholder {
  color: white !important;
}

/* Titulares y headers siguen siendo blancos (por si algo los sobreescribe) */
.header,
.header *,
.card h2,
.card h1,
.card h3 {
  color: white !important;
}

/* La tabla tiene filas oscuras, as√≠ que mantenemos texto blanco */
table,
table *,
td,
td * {
  color: white !important;
}

/* Encabezados de tabla debe mantener texto blanco */
th,
th * {
  color: white !important;
}

/* Badges deben conservar sus colores originales */
.badge.ok {
  background: #163016 !important;
  color: #a8f0a9 !important;
}
.badge.off {
  background: #301616 !important;
  color: #f0a8a8 !important;
}

</style>
</head>

<body>

<div class="topbar">üì¶ INVENTARIO ‚Äî MEC√ÅNICA WALTER URIOL</div>

<div class="wrapper">
  <div class="frame">

    <!-- TITULAR -->
    <div class="header">Inventario de Aceites</div>

    <!-- VOLVER -->
    <a href="aceite.html" class="btn-back">‚¨Ö Volver al panel</a>

    <!-- =======================
         AGREGAR PRODUCTO
    ======================== -->
    <div class="card">
      <h2>Agregar producto</h2>

      <div class="grid">
        <input id="sku" placeholder="SKU (opcional)">
        <input id="nombre" placeholder="Nombre del producto" oninput="this.value=this.value.toUpperCase()">
        <input id="categoria" placeholder="Categor√≠a (5W30, ATF...)" oninput="this.value=this.value.toUpperCase()">
        <input id="aplicacion" placeholder="Aplicaci√≥n (opcional)" oninput="this.value=this.value.toUpperCase()">

        <input id="costo" type="text" placeholder="Costo ($)" oninput="formatearAuto(this)">
        <input id="precio" type="text" placeholder="Precio venta ($)" oninput="formatearAuto(this)">
        <input id="stock" type="text" placeholder="Stock" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
      </div>

      <button class="btn" onclick="agregar()">Guardar</button>
    </div>

    <!-- =======================
         LISTADO
    ======================== -->
    <div class="card">
      <h2>Listado</h2>

      <input id="buscar" placeholder="Buscar..." oninput="filtrar()">
      <button class="btn" onclick="cargar()">Recargar</button>

      <table id="tbl">
        <thead>
          <tr>
            <th>ID</th>
            <th>SKU</th>
            <th>Nombre</th>
            <th>Categor√≠a</th>
            <th>Venta</th>
            <th>Costo</th>
            <th>Stock</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>
</div>

<div class="footer">¬© 2025 Benjam√≠n Gonz√°lez ‚Äî Todos los derechos reservados.</div>

<!-- Scripts para PWA -->
<script>
  // Registrar el Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('service-worker.js')
        .then(function(registration) {
          console.log('Service Worker registrado con √©xito:', registration.scope);
        })
        .catch(function(error) {
          console.log('Error al registrar el Service Worker:', error);
        });
    });
  }
</script>

<!-- ===========================
     JAVASCRIPT API + FUNCIONES
=========================== -->
<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbylNvMd3YLMCAmO9vxmB3dzJ9J2LxayYu7-Tlucwbl-aNRJC8OJe3srJRfPjcdnCWg/exec";

const api = async (action,payload={})=>{
  try{
    const r=await fetch(BASE_URL,{
      method:"POST",
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body:JSON.stringify({action,payload})
    });
    return r.json();
  }catch(err){return {ok:false,error:err.message};}
};

let productos=[];
const $=id=>document.getElementById(id);

/* ‚≠ê FORMATO AUTOM√ÅTICO */
function formatearAuto(input){
  let val = input.value.replace(/\./g,"").replace(",",".");
  if(val==="") return;

  let num = Number(val);
  if(isNaN(num)) return;

  input.value = num.toLocaleString("es-CL",{maximumFractionDigits:2});
}

/* üîÑ CARGAR */
async function cargar(){
  const r=await api('listInventory');
  if(!r.ok) return alert('Error: '+r.error);
  productos=r.data||[];
  render(productos);
}

/* TABLA */
function render(list){
  const tb=document.querySelector('#tbl tbody');
  tb.innerHTML='';
  list.forEach(p=>{
    tb.innerHTML+=`
      <tr>
        <td>${p.id}</td>
        <td>${p.sku||'-'}</td>
        <td>${p.nombre}</td>
        <td>${p.categoria||'-'}</td>
        <td>${p.precio_unit.toLocaleString('es-CL')}</td>
        <td>${p.costo_unit.toLocaleString('es-CL')}</td>
        <td>${p.stock}</td>
        <td>${p.activo ? '<span class="badge ok">Activo</span>' : '<span class="badge off">Inactivo</span>'}</td>
      </tr>`;
  });
}

/* BUSCAR */
function filtrar(){
  const q=$('buscar').value.toUpperCase();
  render(productos.filter(p=>
    p.nombre.toUpperCase().includes(q) ||
    p.sku.toUpperCase().includes(q) ||
    p.categoria.toUpperCase().includes(q)
  ));
}

/* AGREGAR */
async function agregar(){
  const costoNum = Number(costo.value.replace(/\./g,"").replace(",","."));  
  const precioNum = Number(precio.value.replace(/\./g,"").replace(",","."));
  const stockNum  = Number(stock.value || "0");

  const item={
    sku: sku.value.trim() || 'SKU-'+Date.now(),
    nombre: nombre.value.trim().toUpperCase(),
    categoria: categoria.value.trim().toUpperCase(),
    aplicacion: aplicacion.value.trim().toUpperCase(),
    costo_unit: costoNum,
    precio_unit: precioNum,
    stock: stockNum
  };

  if(!item.nombre) return alert('Debe ingresar un nombre');

  const r = await api('addInventory',{item});
  if(!r.ok) return alert('Error: '+r.error);

  document.querySelectorAll('input').forEach(i=>i.value='');
  cargar();
}

cargar();
</script>

</body>
</html>