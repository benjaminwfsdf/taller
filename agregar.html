<!DOCTYPE html>
<html lang="es">
<head>
  <base target="_self">

  <link rel="manifest" href="/manifest.json">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Taller">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <meta name="theme-color" content="#000000">
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="img/scanner.png">
  <title>Agregar Vehículo | Walter Uriol</title>

  <!-- FIX iPhone -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <style>
    :root{
      --brand:#d40000;
      --brand-dark:#9b0000;
      --blue:#1d3053;
      --blue-dark:#1d3053;
      --ink:#ffffff;
      --radius:18px;
      --shadow:0 12px 30px rgba(0,0,0,.45);
      --shadow-soft:0 10px 26px rgba(0,0,0,.25);
    }

    * { box-sizing: border-box; }

    body{
      margin:0;
      background-image: url("img/portada_celular.png");
      background-repeat:no-repeat;
      background-size:cover;
      background-position:center;
      min-height:100vh;
      overflow-x:hidden;
      font-family:system-ui,Segoe UI,Roboto,Arial;
      background-color:#000;
      position:relative;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background-image:inherit;
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      z-index:-1;
    }

    input[type="text"]{
      width:100%;
      padding:14px;
      border:2px solid rgba(255,255,255,0.2);
      border-radius:12px;
      background:rgba(0,0,0,0.45);
      color:white !important;
      text-transform:uppercase;
      font-size:16px;
    }

    input[type="text"]:focus{
      outline:none;
      border-color:var(--brand);
      background:rgba(0,0,0,0.55);
    }

    #telefono{ text-transform:none; }
    #kilometraje{ text-transform:none; }
    
    /* Estilo para campo OT (solo lectura) */
    .ot-field {
      background: rgba(0,0,0,0.6) !important;
      border: 2px solid var(--brand) !important;
      color: #ffcc00 !important;
      font-weight: 900;
      font-size: 18px;
      letter-spacing: 2px;
      text-align: center;
      cursor: not-allowed;
    }

    .ot-label {
      color: #ffcc00;
      font-weight: 800;
      text-align: center;
      margin: 16px 0 8px;
      font-size: 18px;
    }

    .topbar{
      background:#1d3053;
      color:white;
      text-align:center;
      padding:14px;
      font-weight:700;
      border-bottom:5px solid var(--brand);
      box-shadow:var(--shadow-soft);
      position:sticky;
      top:0;
      z-index:10;
    }

    .wrapper{
      max-width:1100px;
      margin:38px auto 60px;
      padding:0 18px;
    }

    .frame{
      background:rgba(135,206,250,0.35);
      border-radius:var(--radius);
      padding:22px;
      border:3px solid var(--brand);
      backdrop-filter:blur(8px);
      box-shadow:var(--shadow);
    }

    .header{
      background:#1d3053;
      color:white;
      padding:20px;
      border-radius:16px;
      text-align:center;
      border:3px solid var(--brand);
      text-shadow:0 3px 8px black;
      font-weight:900;
      margin-bottom:22px;
    }

    .card{
      background:#1d3053;
      border:3px solid var(--brand);
      border-radius:16px;
      padding:20px;
      width:100%;
      margin-bottom:22px;
      box-shadow:var(--shadow);
    }

    .table-container{
      width:100%;
      overflow-x:auto;
    }

    table{
      width:100%;
      min-width:720px;
      border-collapse:collapse;
      background:rgba(0,0,0,0.3);
      color:white;
      border-radius:12px;
      overflow:hidden;
    }

    th,td{
      border:1px solid rgba(255,255,255,0.1);
      padding:12px;
      text-align:left;
    }

    th{
      background:rgba(0,0,0,0.35);
      font-weight:700;
    }

    .btn{
      width:100%;
      padding:12px 24px;
      background:white;
      color:black;
      border-radius:14px;
      border:3px solid var(--brand);
      font-weight:900;
      font-size:18px;
      box-shadow:0 4px 10px rgba(0,0,0,.35);
      cursor:pointer;
      margin-top:16px;
      text-align:center;
      display:block;
    }

    .btn-secondary{
      background:transparent !important;
      color:white !important;
      border-color:white !important;
      width:auto !important;
      padding:12px 24px;
      margin-top:16px;
      display:inline-block;
    }

    .footer{
      text-align:center;
      color:white;
      font-size:13px;
      margin-top:22px;
      text-shadow:0 2px 6px black;
    }
    
    /* Mensaje OT */
    .ot-message {
      text-align: center;
      color: #ffcc00;
      font-weight: 700;
      margin: 8px 0;
      font-size: 14px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    }
    
    /* Caché status */
    .cache-status {
      font-size: 12px;
      color: #90ee90;
      text-align: center;
      margin-top: 5px;
    }
    
    /* Mensaje autocompletado */
    .auto-complete-msg {
      font-size: 12px;
      color: #ffcc00;
      text-align: center;
      margin: 5px 0;
      font-style: italic;
    }
  </style>
</head>

<body>

<div class="topbar">WWW.MECANICAWALTERURIOL.CL</div>

<div class="wrapper">
<div class="frame">

  <div class="header"><h1>Agregar Vehículo</h1></div>

  <div class="card">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Patente</th>
            <th>Nombre del Dueño</th>
            <th>Teléfono</th>
            <th>Dirección</th>
            <th>Marca</th>
            <th>Modelo</th>
            <th>Kilometraje</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td><input type="text" id="patente" placeholder="ABCD12"></td>
            <td><input type="text" id="nombre" placeholder="JUAN PÉREZ"></td>
            <td><input type="text" id="telefono" value="+56 9 " maxlength="14" oninput="formatearTelefono(this)"></td>
            <td><input type="text" id="direccion" placeholder="AV. PRINCIPAL 123"></td>
            <td><input type="text" id="marca" placeholder="TOYOTA"></td>
            <td><input type="text" id="modelo" placeholder="COROLLA"></td>
            <td><input type="text" id="kilometraje" placeholder="150.000" oninput="formatearKilometraje(this)"></td>
          </tr>

          <tr>
            <th colspan="7" style="text-align:center;">Motivo / Detalle</th>
          </tr>

          <tr>
            <td colspan="7"><input type="text" id="detalle" placeholder="NO PARTE · REVISION · CAMBIO DE ACEITE"></td>
          </tr>

        </tbody>
      </table>
    </div>
    
    <!-- Mensaje autocompletado -->
    <div id="autoCompleteMsg" class="auto-complete-msg"></div>
    
    <!-- Sección OT (solo lectura) -->
    <div class="ot-label">Orden de Trabajo asignada:</div>
    <input type="text" id="ot_asignada" class="ot-field" readonly>
    <div id="cacheStatus" class="cache-status"></div>
    <div class="ot-message">Esta OT se asignará automáticamente al guardar</div>

    <!-- Botón Guardar -->
    <button class="btn" onclick="guardarVehiculo()">Guardar Vehículo</button>

    <!-- Botón Volver (posición restaurada) -->
    <a href="gestion_autos.html" class="btn btn-secondary">← Volver al Menú Principal</a>

  </div>

</div>

<div class="footer">© 2025 Benjamín González — Todos los derechos reservados.</div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyWbgK5VnKJvHqtfXLuhoarlEQJkBOgmm1-7Xku8yz-3T8U85WHeCNYQH5SGvLKS09yxA/exec";
const CACHE_KEY = 'ultima_ot_cache';
const CACHE_TIMEOUT = 5 * 60 * 1000; // 5 minutos

let siguienteOT = "";
let otCache = null;
let VISITAS = [];

/* ============================
   FORMATEOS
============================ */
function formatearTelefono(input){
  if(!input.value.startsWith("+56 9 ")) input.value = "+56 9 ";
  let resto = input.value.slice(6).replace(/\D/g,'').slice(0,8);
  input.value = "+56 9 " + resto;
}

function formatearKilometraje(input){
  let val = input.value.replace(/\D/g,'');
  if(!val){ input.value=""; return; }
  input.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

/* ============================
   SISTEMA DE CACHÉ LOCAL CORREGIDO
============================ */
function cargarCacheOT() {
  try {
    const cacheData = localStorage.getItem(CACHE_KEY);
    if (cacheData) {
      const cache = JSON.parse(cacheData);
      const ahora = Date.now();
      
      // Si la caché es reciente (menos de 5 minutos)
      if (ahora - cache.timestamp < CACHE_TIMEOUT) {
        otCache = cache;
        return cache.nextOT;
      }
    }
  } catch (e) {
    console.log('Error cargando caché:', e);
  }
  return null;
}

function guardarCacheOT(ultimaOTReal) {
  // IMPORTANTE: Guardar la OT REAL del servidor, no incrementarla
  const nextOT = String(ultimaOTReal).padStart(6, "0");
  otCache = {
    lastOT: ultimaOTReal,
    timestamp: Date.now(),
    nextOT: nextOT
  };
  localStorage.setItem(CACHE_KEY, JSON.stringify(otCache));
  return nextOT;
}

function obtenerOTParaMostrar() {
  // Si tenemos caché, usarla
  if (otCache) {
    return otCache.nextOT;
  }
  return "000001";
}

/* ============================
   OBTENER OT - CORREGIDO
============================ */
async function obtenerSiguienteOT() {
  // Mostrar mensaje temporal
  document.getElementById('cacheStatus').textContent = "⏳ Obteniendo OT...";
  
  try {
    // Obtener OT DIRECTAMENTE del servidor
    const response = await fetch(`${API_URL}?action=obtenerSiguienteOT_Hoja1&_=${Date.now()}`);
    if (response.ok) {
      const data = await response.json();
      if (data.success && data.nextOT) {
        // Usar la OT que devuelve el servidor
        siguienteOT = data.nextOT;
        document.getElementById('ot_asignada').value = siguienteOT;
        
        // Guardar en caché SIN MODIFICAR
        const otNumber = parseInt(siguienteOT.replace(/\D/g, ''), 10);
        guardarCacheOT(otNumber);
        
        document.getElementById('cacheStatus').textContent = "✓ OT obtenida del servidor";
        setTimeout(() => {
          document.getElementById('cacheStatus').textContent = "";
        }, 3000);
      }
    } else {
      throw new Error('Respuesta no OK');
    }
  } catch (error) {
    console.log('Error obteniendo OT del servidor:', error);
    
    // Intento con caché local
    const cacheOT = cargarCacheOT();
    if (cacheOT) {
      siguienteOT = cacheOT;
      document.getElementById('ot_asignada').value = siguienteOT;
      document.getElementById('cacheStatus').textContent = "⚠️ Usando OT local (sin conexión)";
    } else {
      siguienteOT = "000001";
      document.getElementById('ot_asignada').value = siguienteOT;
      document.getElementById('cacheStatus').textContent = "⚠️ Error, usando OT por defecto";
    }
  }
}

/* ============================
   AUTOCOMPLETAR POR PATENTE
============================ */
async function cargarDatos() {
  try {
    const response = await fetch(API_URL);
    if (response.ok) {
      VISITAS = await response.json();
      console.log(`✅ Datos cargados: ${VISITAS.length} registros`);
    }
  } catch(e) { 
    console.log('⚠️ Error cargando datos:', e);
  }
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

document.getElementById("patente").addEventListener("input", debounce(() => {
  const pat = document.getElementById("patente").value.trim().toUpperCase();
  const msgDiv = document.getElementById("autoCompleteMsg");
  
  if (pat.length < 4) {
    msgDiv.textContent = "";
    return;
  }

  const match = VISITAS.find(r => {
    const patenteRegistro = String(r["Patente"] || r["patente"] || "").toUpperCase();
    return patenteRegistro === pat;
  });

  if (match) {
    document.getElementById('nombre').value = (match["Nombre"] || "").toUpperCase();
    
    const telefonoOriginal = match["Teléfono"] || match["Telefono"] || "";
    let telefonoFormateado = "+56 9 ";
    if (telefonoOriginal) {
      const numeros = telefonoOriginal.replace(/\D/g, '');
      if (numeros.length >= 8) {
        telefonoFormateado += numeros.slice(-8);
      }
    }
    document.getElementById('telefono').value = telefonoFormateado;
    
    document.getElementById('direccion').value = (match["Dirección"] || match["Direccion"] || "").toUpperCase();
    document.getElementById('marca').value = (match["Marca"] || "").toUpperCase();
    document.getElementById('modelo').value = (match["Modelo"] || "").toUpperCase();
    
    msgDiv.textContent = `✓ Vehículo encontrado. Puedes editar los datos si es necesario.`;
    msgDiv.style.color = "#90ee90";
    
  } else {
    msgDiv.textContent = "No se encontraron registros para esta patente";
    msgDiv.style.color = "#ffcc00";
  }
}, 500));

/* ============================
   GUARDAR VEHÍCULO - CORREGIDO
============================ */
async function guardarVehiculo(){
  const patente = document.getElementById('patente').value.trim();
  const nombre = document.getElementById('nombre').value.trim();
  const telefono = document.getElementById('telefono').value;
  const direccion = document.getElementById('direccion').value.trim();
  const marca = document.getElementById('marca').value.trim();
  const modelo = document.getElementById('modelo').value.trim();
  const kilometraje = document.getElementById('kilometraje').value.trim();
  const detalle = document.getElementById('detalle').value.trim();

  if (!patente) return alert("⚠️ Ingresa la patente");
  if (!nombre) return alert("⚠️ Ingresa el nombre del dueño");
  if (!telefono) return alert("⚠️ Ingresa el teléfono");
  if (!direccion) return alert("⚠️ Ingresa la dirección");
  if (!marca) return alert("⚠️ Ingresa la marca");
  if (!modelo) return alert("⚠️ Ingresa el modelo");
  if (!kilometraje) return alert("⚠️ Ingresa el kilometraje");
  if (!detalle) return alert("⚠️ Ingresa el motivo/detalle");

  // Usar la OT que ya tenemos (siguienteOT)
  const otParaGuardar = siguienteOT || "000001";
  
  const telefonoParaGuardar = telefono.replace(/\D/g, '');
  
  const datos = {
    nombre: nombre.toUpperCase(),
    telefono: telefonoParaGuardar,
    direccion: direccion.toUpperCase(),
    marca: marca.toUpperCase(),
    modelo: modelo.toUpperCase(),
    patente: patente.toUpperCase(),
    kilometraje: kilometraje,
    detalle_estado: detalle.toUpperCase()
  };

  const confirmar = confirm(`¿Guardar vehículo con OT ${otParaGuardar}?\n\nPatente: ${datos.patente}\nNombre: ${datos.nombre}\nTeléfono: ${telefono}\nOT: ${otParaGuardar}`);
  
  if (!confirmar) return;

  try {
    const formData = new FormData();
    for (const key in datos) {
      formData.append(key, datos[key]);
    }

    const response = await fetch(API_URL, {
      method: "POST",
      body: formData,
      mode: 'no-cors'
    });

    // IMPORTANTE: NO incrementar la caché aquí
    // Solo invalidar la caché para que se actualice en el próximo uso
    localStorage.removeItem(CACHE_KEY);
    
    alert(`✔ Vehículo guardado exitosamente\nOT asignada: ${otParaGuardar}`);
    
    // Limpiar formulario
    setTimeout(() => {
      document.getElementById('patente').value = "";
      document.getElementById('nombre').value = "";
      document.getElementById('telefono').value = "+56 9 ";
      document.getElementById('direccion').value = "";
      document.getElementById('marca').value = "";
      document.getElementById('modelo').value = "";
      document.getElementById('kilometraje').value = "";
      document.getElementById('detalle').value = "";
      document.getElementById('autoCompleteMsg').textContent = "";
      
      // Obtener NUEVA OT para el próximo registro
      obtenerSiguienteOT();
    }, 500);

  } catch (error) {
    console.error('Error guardando vehículo:', error);
    
    alert(`⚠️ Error de conexión\n\nVehículo listo para guardar:\nOT: ${otParaGuardar}\nPatente: ${datos.patente}\n\nPor favor, inténtalo nuevamente.`);
    
    // Guardar pendiente pero NO incrementar OT localmente
    const pendientes = JSON.parse(localStorage.getItem('pendientes_guardar') || '[]');
    pendientes.push({
      datos: datos,
      ot: otParaGuardar,
      timestamp: new Date().toISOString()
    });
    localStorage.setItem('pendientes_guardar', JSON.stringify(pendientes));
  }
}

/* ============================
   INICIALIZACIÓN
============================ */
document.addEventListener('DOMContentLoaded', () => {
  // 1. Cargar OT del servidor (siempre fresco)
  obtenerSiguienteOT();
  
  // 2. Cargar datos para autocompletar
  cargarDatos();
  
  // 3. Intentar reenviar pendientes si los hay
  setTimeout(() => {
    const pendientes = JSON.parse(localStorage.getItem('pendientes_guardar') || '[]');
    if (pendientes.length > 0) {
      console.log(`Hay ${pendientes.length} registros pendientes de guardar`);
    }
  }, 2000);
});

</script>

</body>
</html>
