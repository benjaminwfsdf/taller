<!DOCTYPE html>
<html lang="es">
<head>
  <base target="_self">

  <link rel="manifest" href="/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Taller">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <meta name="theme-color" content="#000000">
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="img/scanner.png">
  <title>Actualizar Estado del Veh√≠culo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <style>
    :root{
      --brand:#d40000;
      --brand-dark:#9b0000;
      --blue:#1d3053;
      --blue-dark:#1d3053;
      --ink:#ffffff;
      --radius:18px;
      --shadow:0 12px 30px rgba(0,0,0,.45);
      --shadow-soft:0 10px 26px rgba(0,0,0,.25);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background-image:url("img/portada_celular.png");
      background-repeat:no-repeat;
      background-size:cover;
      background-position:center;
      min-height:100vh;
      overflow-x:hidden;
      position:relative;
      font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif !important;
      background-color:#000;
      color:white;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background-image:inherit;
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      z-index:-1;
    }

    .topbar{
      background:#1d3053;
      color:white;
      text-align:center;
      padding:14px;
      font-weight:700;
      letter-spacing:.8px;
      border-bottom:5px solid var(--brand);
      box-shadow:var(--shadow-soft);
      position:sticky;
      top:0;
      z-index:10;
    }

    .wrapper{
      max-width:1100px;
      margin:38px auto 60px;
      padding:0 22px;
      width:100%;
    }

    .frame{
      background:rgba(135,206,250,0.35);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:var(--shadow);
      border:3px solid var(--brand);
      backdrop-filter:blur(8px);
      margin:0 auto;
    }

    .header{
      background:#1d3053;
      color:white;
      border-radius:16px;
      padding:20px;
      text-align:center;
      font-weight:900;
      border:3px solid var(--brand);
      text-shadow:0 3px 8px rgba(0,0,0,.6);
      margin-bottom:20px;
      font-size:clamp(1.5rem,5vw,2.2rem);
    }

    .card{
      background:#1d3053;
      border:3px solid var(--brand);
      border-radius:16px;
      padding:24px;
      box-shadow:var(--shadow);
      margin-bottom:20px;
      width:100%;
    }

    label{
      display:block;
      margin:14px 0 6px;
      font-weight:800;
      color:#ffffff;
      font-size:clamp(1rem,3vw,1.1rem);
    }

    input{
      width:100%;
      padding:14px 16px;
      border:2px solid var(--brand);
      border-radius:12px;
      background:#0f1a2f;
      color:#ffffff !important;
      font-size:clamp(1rem,3vw,1.1rem);
      text-transform:uppercase;
      font-weight:600;
    }

    .btn{
      width:100%;
      margin-top:20px;
      border-radius:14px;
      padding:14px 16px;
      font-weight:900;
      cursor:pointer;
      color:#000;
      background:#ffffff;
      border:3px solid var(--brand);
      box-shadow:0 4px 10px rgba(0,0,0,.35);
      transition:.25s;
      font-size:clamp(1rem,3vw,1.1rem);
      text-align:center;
    }

    .btn:hover{
      background:var(--blue-dark);
      color:white !important;
      border-color:var(--brand-dark);
    }

    .btn-secondary{
      background:transparent;
      color:white !important;
      border-color:white;
      margin-top:14px;
    }

    .resultado{
      margin-top:18px;
      padding:16px;
      border-radius:14px;
      background:rgba(0,0,0,0.35);
      border:2px solid rgba(255,255,255,0.15);
    }

    .opcion{
      background:rgba(0,0,0,0.45);
      border:2px solid var(--brand);
      border-radius:12px;
      padding:12px 14px;
      margin-bottom:10px;
      cursor:pointer;
      transition:.2s;
    }

    .opcion:hover{
      background:rgba(212,0,0,0.9);
      border-color:#fff;
    }

    .opcion strong{
      display:block;
      margin-bottom:4px;
      font-size:0.95rem;
    }

    .opcion small{
      display:block;
      font-size:0.85rem;
      opacity:0.9;
    }

    .status{
      margin-top:10px;
      font-weight:700;
      font-size:0.95rem;
    }

    .footer{
      text-align:center;
      color:white;
      font-size:13px;
      margin-top:22px;
      text-shadow:0 2px 6px black;
      padding:0 10px;
    }
  </style>
</head>

<body>
  <div class="topbar">WWW.MECANICAWALTERURIOL.CL</div>

  <div class="wrapper">
    <div class="frame">
      <div class="header">Actualizar Estado del Veh√≠culo</div>

      <div class="card">
        <label for="patente">Patente del Veh√≠culo</label>
        <input id="patente" placeholder="ABCD12">

        <button class="btn" onclick="buscarVisitas()">üîç Buscar Visitas</button>

        <div id="mensaje" class="status">‚è≥ Esperando b√∫squeda‚Ä¶</div>

        <div id="lista" class="resultado" style="display:none;"></div>

        <button class="btn btn-secondary" onclick="location.href='gestion_autos.html'">
          ‚Üê Volver al Men√∫ Principal
        </button>
      </div>

      <div class="footer">¬© 2025 Benjam√≠n Gonz√°lez ‚Äî Todos los derechos reservados.</div>
    </div>
  </div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzCtbXzWEBdvkyWQKobmqhS6z6ZXLxWsRdwwA7l7axDTWbWeOj7Sws2ggbgQowRnhYBng/exec"; // üîÅ reemplaza por tu URL de Apps Script

function formatearFecha(fechaRaw){
  if (!fechaRaw) return "";
  const d = new Date(fechaRaw);
  if (isNaN(d)) return "";
  return d.toLocaleDateString('es-CL'); // dd-mm-aaaa
}

async function buscarVisitas(){
  const patente = document.getElementById("patente").value.trim().toUpperCase();
  const mensaje = document.getElementById("mensaje");
  const lista = document.getElementById("lista");

  if (!patente){
    alert("‚ö†Ô∏è Ingresa la patente.");
    return;
  }

  mensaje.textContent = "‚è≥ Buscando...";
  lista.style.display = "none";
  lista.innerHTML = "";

  try{
    const res = await fetch(API, {
      method:"POST",
      body:JSON.stringify({
        funcion:"listarporpatente",
        patente:patente
      })
    });

    const data = await res.json();

    if (!data.length){
      mensaje.textContent = "‚ùå No hay autos en REPARACI√ìN con esa patente.";
      return;
    }

    mensaje.textContent = "Selecciona cu√°l pasar a LISTO:";
    lista.style.display = "block";

    data.forEach(v => {
      const div = document.createElement("div");
      div.className = "opcion";

      const fechaStr = formatearFecha(v.Fecha);
      const detalle = (v.Detalle || "").trim() || "SIN DETALLE REGISTRADO";

      div.innerHTML = `
        <strong>${v.Marca} ${v.Modelo}</strong>
        <small>üìÖ Fecha: ${fechaStr}</small>
        <small>üõ†Ô∏è Detalle: ${detalle}</small>
      `;

      div.onclick = () => confirmarCambio(v.fila);
      lista.appendChild(div);
    });

  } catch(e){
    console.error(e);
    mensaje.textContent = "‚ùå Error al consultar el servidor.";
  }
}

async function confirmarCambio(fila){
  if (!confirm("¬øMarcar este veh√≠culo como LISTO?")) return;

  try{
    await fetch(API, {
      method:"POST",
      body:JSON.stringify({
        funcion:"actualizarfila",
        fila:fila
      })
    });
    alert("‚úî Veh√≠culo marcado como LISTO.");
    buscarVisitas(); // refrescar lista
  } catch(e){
    alert("‚ùå Error al actualizar.");
  }
}
</script>

</body>
</html>
