<!DOCTYPE html>
<html lang="es-CL">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‚úèÔ∏è Editar Visitas ¬∑ Veh√≠culos | Walter Uriol</title>
  <meta name="theme-color" content="#000000">

  <style>
    :root{
      --brand:#d40000;
      --brand-dark:#9b0000;
      --blue:#1d3053;
      --ink:#ffffff;
      --radius:18px;
      --shadow:0 12px 30px rgba(0,0,0,.45);
      --shadow-soft:0 10px 26px rgba(0,0,0,.25);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:white;
      min-height:100dvh;
      overflow-x:hidden;

      background:url("img/portada_celular.png") no-repeat center/cover fixed;
      background-color:#000;
    }

    @media(min-width:768px){
      body{
        background:url("img/portada_pc.png") no-repeat center/cover fixed;
      }
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background-image:inherit;
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      z-index:-1;
      pointer-events:none;
    }

    .topbar{
      background:#1d3053;
      color:white;
      text-align:center;
      padding:14px;
      font-weight:700;
      border-bottom:5px solid var(--brand);
      box-shadow:var(--shadow-soft);
      position:sticky;
      top:0;
      z-index:10;
    }

    .wrapper{
      max-width:1100px;
      margin:30px auto 40px;
      padding:0 18px;
    }

    .frame{
      background:rgba(135,206,250,0.35);
      border-radius:var(--radius);
      padding:22px;
      border:3px solid var(--brand);
      box-shadow:var(--shadow);
      backdrop-filter:blur(8px);
    }

    .header{
      background:#1d3053;
      border-radius:16px;
      border:3px solid var(--brand);
      padding:20px;
      text-align:center;
      font-weight:900;
      margin-bottom:18px;
    }

    .header h1{
      margin:0;
      font-size:clamp(1.5rem,5vw,2.2rem);
    }

    .card{
      background:#1d3053;
      border-radius:16px;
      border:3px solid var(--brand);
      padding:16px;
      margin-bottom:18px;
      box-shadow:var(--shadow);
    }

    .title{
      margin:0 0 12px;
      font-size:clamp(1.2rem,4vw,1.6rem);
      font-weight:900;
      text-align:center;
    }

    input, textarea{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:2px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.35);
      color:white;
      font-size:15px;
      margin-bottom:10px;
      text-transform:uppercase;
    }

    textarea{
      resize:vertical;
      min-height:60px;
    }

    input:focus, textarea:focus{
      border-color:var(--brand);
      outline:none;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }

    th,td{
      padding:8px;
      text-align:center;
      border-bottom:1px solid rgba(255,255,255,0.2);
    }

    th{
      background:rgba(0,0,0,0.3);
      font-weight:800;
    }

    tr.clickable:hover{
      background:rgba(255,255,255,0.08);
      cursor:pointer;
    }

    .btn{
      background:white;
      color:black;
      padding:12px 18px;
      border-radius:14px;
      border:3px solid var(--brand);
      font-weight:900;
      font-size:15px;
      box-shadow:0 4px 10px rgba(0,0,0,.35);
      cursor:pointer;
      width:100%;
      margin-top:10px;
    }

    .btn-secondary{
      background:transparent;
      color:white;
      border:3px solid white;
      border-radius:14px;
      padding:10px 18px;
      font-weight:900;
      display:inline-block;
      margin-top:10px;
    }

    .footer{
      text-align:center;
      margin-top:18px;
      font-size:13px;
      text-shadow:0 2px 6px black;
    }

    /* Nuevos estilos para b√∫squeda m√∫ltiple */
    .search-tabs{
      display:flex;
      gap:8px;
      margin-bottom:12px;
      justify-content:center;
      flex-wrap:wrap;
    }

    .search-tab{
      padding:8px 16px;
      border-radius:10px;
      background:rgba(0,0,0,0.35);
      border:2px solid rgba(255,255,255,0.25);
      color:white;
      font-weight:700;
      cursor:pointer;
      transition:all 0.2s;
      font-size:14px;
    }

    .search-tab:hover{
      background:rgba(255,255,255,0.1);
    }

    .search-tab.active{
      background:var(--brand);
      border-color:var(--brand);
    }

    .search-container{
      display:none;
    }

    .search-container.active{
      display:block;
    }

    .help-box{
      background:rgba(0,0,0,0.35);
      border:2px solid rgba(255,255,255,0.15);
      border-radius:10px;
      padding:12px;
      margin:12px 0;
      font-size:13px;
    }

    .help-box ul{
      margin:8px 0;
      padding-left:20px;
    }

    .help-box li{
      margin:4px 0;
    }

    .no-results{
      text-align:center;
      padding:20px;
      color:rgba(255,255,255,0.7);
      font-style:italic;
    }

    .search-hint{
      font-size:13px;
      opacity:.85;
      text-align:center;
      margin-top:8px;
      color:rgba(255,255,255,0.8);
    }
  </style>
</head>

<body>

<div class="topbar">WWW.MECANICAWALTERURIOL.CL</div>

<div class="wrapper">
  <div class="frame">

    <div class="header"><h1>‚úèÔ∏è Editar Visitas de Veh√≠culos</h1></div>

    <!-- Buscar historial MEJORADO -->
    <div class="card">
      <h2 class="title">1. Buscar visitas</h2>
      
      <!-- Pesta√±as de b√∫squeda -->
      <div class="search-tabs">
        <div class="search-tab active" data-tab="patente">üîç Patente</div>
        <div class="search-tab" data-tab="nombre">üßë Nombre</div>
        <div class="search-tab" data-tab="telefono">üìû Tel√©fono</div>
      </div>
      
      <!-- B√∫squeda por patente -->
      <div class="search-container active" id="search-patente">
        <input id="patente_buscar" placeholder="INGRESA PATENTE (EJ: JJSJ31)" />
      </div>
      
      <!-- B√∫squeda por nombre -->
      <div class="search-container" id="search-nombre">
        <input id="nombre_buscar" placeholder="NOMBRE DEL DUE√ëO (EJ: JUAN P√âREZ)" />
      </div>
      
      <!-- B√∫squeda por tel√©fono -->
      <div class="search-container" id="search-telefono">
        <input id="telefono_buscar" placeholder="TEL√âFONO (EJ: 956123456)" />
      </div>
      
      <button class="btn" onclick="filtrarHistorial()">Buscar historial</button>
      
      <!-- Ayuda -->
      <div class="help-box">
        <strong>Consejos de b√∫squeda:</strong>
        <ul>
          <li>Si no recuerdas la patente exacta, usa solo parte de ella</li>
          <li>Puedes buscar por nombre si no tienes la patente</li>
          <li>La b√∫squeda no distingue may√∫sculas/min√∫sculas</li>
          <li>Para tel√©fono: usa solo n√∫meros, sin c√≥digo de pa√≠s</li>
        </ul>
      </div>

      <div style="margin-top:12px; max-height:260px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Fila</th>
              <th>Fecha</th>
              <th>OT</th>
              <th>Nombre</th>
              <th>Patente</th>
              <th>Estado</th>
              <th>Detalle</th>
              <th>KM</th>
            </tr>
          </thead>
          <tbody id="tbodyHistorial"></tbody>
        </table>
      </div>

      <p class="search-hint">
        Toca una fila para cargarla y editar.
      </p>
    </div>

    <!-- Formulario -->
    <div class="card" id="cardEdicion" style="display:none;">
      <h2 class="title">2. Editar visita seleccionada</h2>

      <input id="fila" type="hidden">

      <input id="fecha" readonly placeholder="Fecha">
      <input id="ot" readonly placeholder="Orden de Trabajo">

      <input id="nombre" placeholder="Nombre del due√±o">
      <input id="telefono" placeholder="Tel√©fono">
      <input id="direccion" placeholder="Direcci√≥n">
      <input id="marca" placeholder="Marca">
      <input id="modelo" placeholder="Modelo">
      <input id="patente" placeholder="Patente">
      <input id="estado" placeholder="Estado (REPARACI√ìN / LISTO)">
      <textarea id="detalle_estado" placeholder="Detalle Estado"></textarea>

      <input id="kilometraje" placeholder="Kilometraje">

      <button class="btn" onclick="guardarCambios()">üíæ Guardar cambios</button>
    </div>

    <a href="gestion_autos.html" class="btn-secondary">‚Üê Volver al Men√∫ Principal</a>

  </div>

  <div class="footer">¬© 2025 Benjam√≠n Gonz√°lez ‚Äî Todos los derechos reservados.</div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzmbxQ0uE-w4jof9OqWGc0SREzZOjoAlGdDPYEecHd_ASYSu4d-vCeP1NAWXMM_6AKJiw/exec";

let VISITAS = [];
let visitaSeleccionada = null;
let modoBusqueda = 'patente'; // 'patente', 'nombre', 'telefono'

/* ================================
   üî• CARGAR DATOS (CORREGIDO)
   AGREGA _fila AUTOM√ÅTICAMENTE
================================ */
async function cargarDatos() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();

    VISITAS = data.map((v, i) => ({
      ...v,
      _fila: i + 2   // fila real en Sheets (empieza en 2)
    }));

    console.log(`Datos cargados: ${VISITAS.length} registros`);
  } catch (e) {
    alert("Error cargando datos.");
  }
}
cargarDatos();

/* Formatear fecha */
function formatearFecha(f){
  if(!f) return "-";
  const d = new Date(f);
  if(isNaN(d)) return f;
  return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
}

/* Inicializar pesta√±as de b√∫squeda */
function inicializarTabs() {
  const tabs = document.querySelectorAll('.search-tab');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Remover clase active de todas las pesta√±as
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      // Ocultar todos los contenedores
      document.querySelectorAll('.search-container').forEach(container => {
        container.classList.remove('active');
      });
      
      // Mostrar el contenedor correspondiente
      modoBusqueda = tab.dataset.tab;
      document.getElementById(`search-${modoBusqueda}`).classList.add('active');
      
      // Limpiar resultados anteriores
      document.getElementById('tbodyHistorial').innerHTML = '';
      document.getElementById('cardEdicion').style.display = 'none';
      
      // Enfocar el campo correspondiente
      setTimeout(() => {
        const input = document.getElementById(`${modoBusqueda}_buscar`);
        if (input) input.focus();
      }, 100);
    });
  });
}

/* Inicializar eventos Enter */
function inicializarEventosEnter() {
  ['patente_buscar', 'nombre_buscar', 'telefono_buscar'].forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          filtrarHistorial();
        }
      });
    }
  });
}

/* Buscar historial - MEJORADO con m√∫ltiples criterios */
function filtrarHistorial(){
  let termino = '';
  const tbody = document.getElementById("tbodyHistorial");
  tbody.innerHTML = "";

  // Obtener t√©rmino seg√∫n modo de b√∫squeda
  switch(modoBusqueda) {
    case 'patente':
      termino = document.getElementById('patente_buscar').value.trim().toUpperCase();
      break;
    case 'nombre':
      termino = document.getElementById('nombre_buscar').value.trim().toUpperCase();
      break;
    case 'telefono':
      termino = document.getElementById('telefono_buscar').value.trim();
      break;
  }

  if(!termino){ 
    alert(`Ingresa ${modoBusqueda === 'patente' ? 'una patente' : modoBusqueda === 'nombre' ? 'un nombre' : 'un tel√©fono'}.`); 
    return; 
  }

  let lista = [];
  
  // Filtrar seg√∫n el modo de b√∫squeda
  if (modoBusqueda === 'patente') {
    lista = VISITAS.filter(v =>
      String(v["Patente"] || "").toUpperCase().includes(termino)
    );
  } else if (modoBusqueda === 'nombre') {
    lista = VISITAS.filter(v =>
      String(v["Nombre"] || "").toUpperCase().includes(termino)
    );
  } else if (modoBusqueda === 'telefono') {
    // Buscar por tel√©fono (limpia espacios y caracteres especiales)
    const telefonoLimpio = termino.replace(/\D/g, '');
    lista = VISITAS.filter(v => {
      const telVisita = String(v["Tel√©fono"] || v["Telefono"] || "").replace(/\D/g, '');
      return telVisita.includes(telefonoLimpio);
    });
  }

  if(!lista.length){
    tbody.innerHTML = `
      <tr>
        <td colspan="8" class="no-results">
          No se encontraron registros.<br>
          <small>
            ${modoBusqueda === 'patente' ? 'Intenta con: ‚Ä¢ B√∫squeda parcial (ej: "JJ") ‚Ä¢ Cambiar a b√∫squeda por nombre' : ''}
            ${modoBusqueda === 'nombre' ? 'Intenta con: ‚Ä¢ Primeros apellidos ‚Ä¢ Nombre completo' : ''}
            ${modoBusqueda === 'telefono' ? 'Intenta con: ‚Ä¢ √öltimos 4 d√≠gitos ‚Ä¢ Sin c√≥digo de pa√≠s' : ''}
          </small>
        </td>
      </tr>`;
    cardEdicion.style.display = "none";
    return;
  }

  // Ordenar por fecha m√°s reciente primero
  lista.sort((a, b) => {
    const fechaA = new Date(a["Fecha"] || 0);
    const fechaB = new Date(b["Fecha"] || 0);
    return fechaB - fechaA;
  });

  lista.forEach(v => {
    const tr = document.createElement("tr");
    tr.className = "clickable";

    tr.innerHTML = `
      <td>${v._fila}</td>
      <td>${formatearFecha(v["Fecha"])}</td>
      <td>${v["OrdenTrabajo"]||""}</td>
      <td>${v["Nombre"]||""}</td>
      <td>${v["Patente"]||""}</td>
      <td>${v["Estado"]||""}</td>
      <td>${v["Detalle Estado"]||""}</td>
      <td>${v["Kilometraje"]||""}</td>
    `;
    tr.addEventListener("click", ()=> cargarEnFormulario(v));
    tbody.appendChild(tr);
  });
}

/* Cargar formulario */
function cargarEnFormulario(v){
  visitaSeleccionada = v;
  cardEdicion.style.display = "block";

  fila.value = v._fila;
  fecha.value = formatearFecha(v["Fecha"]);
  ot.value = v["OrdenTrabajo"] || "";

  nombre.value = v["Nombre"] || "";
  telefono.value = v["Tel√©fono"] || v["Telefono"] || "";
  direccion.value = v["Direcci√≥n"] || "";
  marca.value = v["Marca"] || "";
  modelo.value = v["Modelo"] || "";
  patente.value = v["Patente"] || "";
  estado.value = v["Estado"] || "";
  detalle_estado.value = v["Detalle Estado"] || "";
  kilometraje.value = v["Kilometraje"] || "";
  
  // Scroll suave al formulario
  cardEdicion.scrollIntoView({ behavior: 'smooth' });
}

/* Guardar cambios */
async function guardarCambios(){
  if(!visitaSeleccionada){
    alert("Selecciona una visita.");
    return;
  }

  const payload = {
    funcion:"editarvisita",
    fila: fila.value,
    nombre: nombre.value.toUpperCase(),
    telefono: telefono.value,
    direccion: direccion.value.toUpperCase(),
    marca: marca.value.toUpperCase(),
    modelo: modelo.value.toUpperCase(),
    patente: patente.value.toUpperCase(),
    estado: estado.value.toUpperCase(),
    detalle_estado: detalle_estado.value.toUpperCase(),
    kilometraje: kilometraje.value
  };

  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();

    if(data.estado === "OK"){
      alert("‚úî Cambios guardados.");
      cargarDatos();
      // Volver a filtrar con el t√©rmino actual
      const termino = document.getElementById(`${modoBusqueda}_buscar`).value;
      if (termino) filtrarHistorial();
    }else{
      alert("Error: "+data.mensaje);
    }

  }catch(e){
    console.error(e);
    alert("No se pudo guardar.");
  }
}

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => {
  inicializarTabs();
  inicializarEventosEnter();
  // Enfocar campo de patente por defecto
  document.getElementById('patente_buscar').focus();
});

// Funci√≥n para b√∫squeda r√°pida (desde otras p√°ginas)
window.buscarPorPatente = function(patente) {
  if (!patente) return;
  
  // Cambiar a pesta√±a de patente
  document.querySelector('.search-tab[data-tab="patente"]').click();
  document.getElementById('patente_buscar').value = patente.toUpperCase();
  setTimeout(() => filtrarHistorial(), 100);
};
</script>

</body>
</html>
